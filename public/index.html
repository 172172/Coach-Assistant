<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Assistant – Realtime + Assistants Tool (Manual)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0f19;color:#eef;display:flex;flex-direction:column;align-items:center;margin:0;padding:24px;gap:16px}
    .card{width:min(920px,95vw);background:#11182a;border:1px solid #1c2540;border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.35);padding:16px}
    h1{margin:8px 0 0;font-weight:600} .sub{opacity:.8;margin:0 0 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{background:#2b5cff;border:0;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button.secondary{background:#233055}
    .log{height:240px;overflow:auto;background:#0c1222;border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #2a355a;border-radius:999px;margin-right:6px;font-size:12px}
    .small{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="card">
    <h1>Coach Assistant – Linje 65</h1>
    <p class="sub">Realtime röst + verktyg: <span class="pill">search_manual</span> (Assistants-liknande flöde)</p>
    <div class="row">
      <button id="btnConnect">Anslut</button>
      <button id="btnMic" disabled>Starta/Stoppa Mic</button>
      <button id="btnHang" class="secondary" disabled>Lägg på</button>
    </div>
    <div class="row small">
      <span id="status">Status: frånkopplad</span>
    </div>
    <div class="log" id="log"></div>
  </div>

<script>
const logEl = document.getElementById('log');
function log(...args){
  const line = document.createElement('div');
  line.textContent = args.map(a => typeof a==='string'?a:JSON.stringify(a)).join(' ');
  logEl.appendChild(line); logEl.scrollTop = logEl.scrollHeight;
}

let pc, dc, micStream, tokenTimer;
let sessionId = null;
let pendingToolCalls = new Map(); // tool_call_id -> { name, args }

async function getRtToken(){
  const res = await fetch('/api/rt-token');
  if(!res.ok){ throw new Error('rt-token fail'); }
  return res.json(); // { client_secret, url }
}

async function connect(){
  const { client_secret, url } = await getRtToken();
  sessionId = crypto.randomUUID();

  pc = new RTCPeerConnection();
  dc = pc.createDataChannel('oai-events');
  dc.onmessage = onMessage;

  // Spela upp TTS från Realtime
  const audio = document.createElement('audio');
  audio.autoplay = true;
  pc.ontrack = e => { audio.srcObject = e.streams[0]; };

  // Lokalt mic-spår
  micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  micStream.getTracks().forEach(t => pc.addTrack(t, micStream));

  // Skicka offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const baseHeaders = { 'Authorization': `Bearer ${client_secret}`, 'Content-Type':'application/sdp' };
  const sdpRes = await fetch(url, { method:'POST', body:offer.sdp, headers: baseHeaders });
  const answer = { type:'answer', sdp: await sdpRes.text() };
  await pc.setRemoteDescription(answer);

  // Håll token vid liv (förläng om din server gör det möjligt)
  log('Ansluten till Realtime.');
  document.getElementById('status').textContent='Status: ansluten';
  document.getElementById('btnMic').disabled=false;
  document.getElementById('btnHang').disabled=false;

  // Init-instruktioner (samma policy som rt-token skickar)
  send({ type:'session.update', session:{
    instructions: `Du är Coach Assistant för Linje 65. Du MÅSTE använda verktyget search_manual när frågan gäller processer/maskiner/inställningar. Vänta alltid på tool_result innan du svarar. Om manual_context saknas: säg "Oklar information – behöver uppdaterad manual."` ,
    modalities:["audio","text"],
    input_audio_transcription:{ model:"whisper-1" },
    turn_detection:{ type:"server_vad", threshold:0.5, silence_duration_ms:600 }
  }});
}

function hang(){
  if (pc) pc.close();
  if (micStream) micStream.getTracks().forEach(t=>t.stop());
  pc=null; micStream=null; sessionId=null;
  pendingToolCalls.clear();
  document.getElementById('status').textContent='Status: frånkopplad';
  document.getElementById('btnMic').disabled=true;
  document.getElementById('btnHang').disabled=true;
}

function send(payload){ if (dc && dc.readyState==='open') dc.send(JSON.stringify(payload)); }

// Mic toggle
let micOn=false;
function toggleMic(){
  if(!micStream) return;
  micOn=!micOn;
  micStream.getAudioTracks().forEach(t=> t.enabled = micOn);
  document.getElementById('btnMic').textContent = micOn? 'Stoppa Mic' : 'Starta Mic';
}

// Viktigt: 1 styrning – modellen anropar verktyg, vi svarar ALLTID med function_call_output
async function onMessage(evt){
  const m = JSON.parse(evt.data);
  if(m.type==='response.created'){ log('response.created'); }
  if(m.type==='response.output_text.delta'){ /* streaming text */ }
  if(m.type==='response.completed'){ log('response.completed'); }

  if(m.type==='response.function_call'){ // modellens tool-call
    const call = m.function_call;
    const { id: tool_call_id, name, arguments:args } = call;
    pendingToolCalls.set(tool_call_id, { name, args });
    log('Tool call:', name);

    if(name === 'search_manual'){
      try{
        const res = await fetch('/api/search-manual', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query: args.query ?? '', session: { line: 65 } })
        });
        const data = await res.json();

        // ALLTID returnera function_call_output – även vid succé
        send({ type:'response.function_call_output', function_call_id: tool_call_id, output: data });
        log('Tool result skickat (chunks:', (data?.chunks?.length||0), ')');
      }catch(e){
        send({ type:'response.function_call_output', function_call_id: tool_call_id, output: { error: String(e) } });
        log('Tool error returnerat');
      }
    }
  }
}

// UI
document.getElementById('btnConnect').onclick = connect;
document.getElementById('btnMic').onclick = toggleMic;
document.getElementById('btnHang').onclick = hang;
</script>
</body>
</html>
