<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Assistant ‚Äì Linje 65 (Realtime)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121821;--text:#e6edf3;--muted:#9fb0c3;--accent:#5eead4;--danger:#f87171;--ok:#86efac;--pill:#182232}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;background:radial-gradient(1200px 600px at 20% 0%,#0e1621,#0b0f14 75%);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    header .title{font-size:20px;font-weight:700;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#0a0f14}
    .ghost{background:#0d1520;color:var(--text);border:1px solid #233146}
    .danger{background:var(--danger);color:#111}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center}
    input[type="text"],input[type="search"]{background:#0d1622;color:var(--text);border:1px solid #243244;border-radius:10px;padding:10px 12px}
    .pill{background:var(--pill);color:var(--text);padding:8px 12px;border-radius:999px;display:inline-block;margin:6px 6px 0 0;font-size:12px;border:1px solid #26364a}
    .panel{background:var(--panel);border:1px solid #233146;border-radius:16px;padding:14px}
    #output{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .bubble{background:#0f1722;border:1px solid #213145;border-radius:16px;padding:12px 14px;white-space:pre-wrap;line-height:1.45}
    .bubble.user{background:#0f1a27;border-color:#24415a}
    .bubble.assistant{background:#0f1823;border-color:#2c3f57}
    .bubble.error{background:#1b0f12;border-color:#4a1f2a}
    .vis{height:10px;background:#0e1420;border-radius:9999px;overflow:hidden;border:1px solid #213145}
    .vis>b{display:block;height:100%;width:6%;background:linear-gradient(90deg,#85f3d5,#4dd4ff);transition:width .08s linear}
    footer{margin-top:24px;color:var(--muted);font-size:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ü¶æ Coach Assistant ‚Äì Linje 65 (Realtime)</div>
      <div class="controls">
        <div class="row">
          <label class="muted" for="operatorId">Operat√∂r:</label>
          <input id="operatorId" type="text" placeholder="t.ex. kevin" style="width:140px" />
          <button class="ghost" id="saveIdBtn">Spara</button>
        </div>
        <button class="primary" id="rtBtn">Anslut Realtime</button>
        <button class="ghost" id="rtHangup" style="display:none">L√§gg p√•</button>
      </div>
    </header>

    <div class="panel">
      <div class="flex">
        <div id="rtStatus" class="pill">Inte ansluten</div>
        <div id="memStatus" class="pill">Minne: ‚Äî</div>
        <div class="vis" style="flex:1 1 220px; min-width:220px"><b id="micBar"></b></div>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="quickText" type="search" placeholder="Ex: 'Oscar', 'Tobias Gren', 'hierarki chefer', 'vem √§r processingenj√∂r'" style="flex:1" />
        <button class="ghost" id="sendTextBtn">Skicka</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="manualQuery" type="search" placeholder="Testa manual-s√∂k (samma beteende som r√∂st)" style="flex:1" />
        <button class="ghost" id="manualBtn">Testa manual</button>
      </div>

      <div id="output"></div>
    </div>

    <footer>
      Realtime-r√∂st med WebRTC. Manual/RAG via Supabase. Logg + minne i Supabase.
    </footer>
  </div>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    async function fetchJSON(url, opts){ const r=await fetch(url,opts); const t=await r.text(); let j; try{j=JSON.parse(t)}catch{throw new Error(`${r.status} ${r.statusText}: ${t.slice(0,200)}`)} if(!r.ok||j?.ok===false) throw new Error(j?.error||j?.message||`${r.status} ${r.statusText}`); return j; }
    const pill = t => { const d=document.createElement('div'); d.className='pill'; d.textContent=t; return d; };
    const bubble = (t,role='assistant') => { const d=document.createElement('div'); d.className='bubble '+role; d.textContent=t; return d; };
    const errorBubble = t => { const d=document.createElement('div'); d.className='bubble error'; d.textContent=t; return d; };
    const append = el => { $('#output').appendChild(el); el.scrollIntoView({behavior:'smooth',block:'end'}); };

    // ===== Konfig =====
    const RAG_ON_CREATED = false;
    const STRICT_RAG = false;
    const VOICE_MIN_SIM = 0.38; // sn√§llare i r√∂st
    const TEXT_MIN_SIM  = 0.45;
    const PERSON_MIN_SIM = 0.32; // extra sn√§llt f√∂r personfr√•gor

    const HEADING_CANDIDATES = [
      'Personal','Ledning','Ledningsstruktur','Organisation','Organisation & ansvar','Organisation och ansvar','Roller','Team','Kontakt'
    ];

    // ===== State =====
    let rt = {
      pc:null, dc:null, mic:null, remoteAudio:null, connected:false,
      conversation_id:null, _msgCount:0,
      _ragBusy:false, _lastQuery:"", _lastToolCallId:null,
      cancelAutos:false, skipCancelForNextCreate:false, allowedResponseIds:new Set(),
      _lastUserText:"", _liveUserBuf:"",
      _pendingTool:null
    };
    const toolCalls = new Map();
    const RAG_TIMEOUT_MS = 8000;
    const WAIT_FOR_QUERY_MS = 2000;
    let ragTimer = null;

    // ===== Personal-index (namnlista + fuzzy) =====
    const PERSON_INDEX = {
      full: new Set(),        // "Tobias Gren"
      first: new Set(),       // "tobias"
      last: new Set(),        // "gren"
      list: []                // ["Tobias Gren", ...] f√∂r fuzzy
    };
    const NORM = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const LC = s => NORM(String(s)).toLowerCase();

    function addPersonName(name){
      const clean = (name||'').trim().replace(/\s+/g,' ');
      if(!clean) return;
      if (PERSON_INDEX.full.has(clean)) return;
      PERSON_INDEX.full.add(clean);
      PERSON_INDEX.list.push(clean);
      const parts = clean.split(' ');
      if (parts[0]) PERSON_INDEX.first.add(LC(parts[0]));
      if (parts[parts.length-1]) PERSON_INDEX.last.add(LC(parts[parts.length-1]));
    }

    function extractNamesFromText(t){
      // F√∂rnamn Efternamn, inkl. √Ö√Ñ√ñ och bindestreck
      const rx=/\b([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:-[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)?(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:-[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)?)+)\b/g;
      const names = new Set();
      let m; while((m=rx.exec(t||''))!==null){ names.add(m[1]); }
      return [...names];
    }

    function lev(a,b){
      a=NORM(a); b=NORM(b);
      const m=a.length,n=b.length; const dp=Array.from({length:m+1},(_,i)=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j;
      for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){
        const c = a[i-1]===b[j-1] ? 0 : 1;
        dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c);
      }
      return dp[m][n];
    }

    function closestFirstName(tok){
      tok=LC(tok);
      let best=null, bestd=99;
      for(const n of PERSON_INDEX.first){
        const d=lev(tok,n);
        if (d<bestd){ best={name:n,d}; bestd=d; if(d===0) break; }
      }
      return (best && best.d<=2) ? best.name : null; // tolerans 2
    }

    async function buildPersonnelCache(){
      const tryHead = async (h) => {
        const d=await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:'personal',k:40,topK:40,minSim:0.0,heading:h,restrictToHeading:true})});
        (d.snippets||[]).forEach(sn=>{
          extractNamesFromText(sn.text||'').forEach(addPersonName);
        });
        return d.snippets?.length||0;
      };
      let total=0;
      for(const h of HEADING_CANDIDATES){ try{ total += await tryHead(h); }catch{} }
      $('#memStatus').textContent=`Minne: ${PERSON_INDEX.list.length} namn indexerade`;
      append(pill(`üß† Indexerade ${PERSON_INDEX.list.length} namn fr√•n organisationsavsnittet`));
    }

    // ===== Gates =====
    const ROLE_SYNONYMS = {
      'processingenj√∂r': ['processingenj√∂r','process ingenj√∂r','process engineer'],
      'produktionschef': ['produktionschef','production manager','prodchef','line manager','linjechef'],
      'skiftledare':     ['skiftledare','skiftchef','team lead','teamleader','teamledare'],
      'underh√•llschef':  ['underh√•llschef','maintenance manager','uh-chef','underh√•ll'],
      'kvalitetstekniker':['kvalitetstekniker','quality engineer','qa','kvalitet'],
      'operat√∂r':        ['operat√∂r','operator'],
      'tekniker':        ['tekniker','technician','service'],
      'linjeledare':     ['linjeledare','line leader','linelead','linje ledare','ll'],
      'teknisk linjeledare': ['teknisk linjeledare','technical line leader','tll','tech line leader']
    };
    const PERSON_TRIGGERS = ['vem √§r','vilken','vilka √§r','ansvarar','arbetsuppgift','arbetsuppgifter','roll','chef','personal','kontakt','telefon','mail','email','hierarki','rapporterar','√∂verordnad','underordnad','chef √∂ver','chef f√∂r'];

    function roleTokensFor(q){
      const low = LC(q); const tokens = [];
      for (const [role, syns] of Object.entries(ROLE_SYNONYMS)){
        if (syns.some(s => low.includes(LC(s)))) tokens.push(role);
      }
      return tokens;
    }

    function isPersonnelQuery(q){
      const low = LC(q);
      const hasTrigger = PERSON_TRIGGERS.some(t => low.includes(LC(t)));
      const hasRole = roleTokensFor(q).length>0;
      const looksLikeFullName = /\b[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+\b/.test(q);
      // nytt: om ett ord matchar (eller √§r n√§ra) ett k√§nt f√∂rnamn ‚Üí true
      const toks = low.split(/\s+/).filter(Boolean);
      const matchesCache = toks.some(t => PERSON_INDEX.first.has(t) || PERSON_INDEX.last.has(t) || !!closestFirstName(t));
      return hasTrigger || hasRole || looksLikeFullName || matchesCache;
    }

    // Linje-relaterat (brett)
    const linjeKeywords = [
      'linje','manual','tapp','givare','sensor','ocme','okme','√•cme','fels√∂k','format','karusell','ventil','carlsberg',
      'person','anst√§lld','operat√∂r','chef','namn','medarbetare','sortbyte','byte','produktion','kister','kistler',
      'processingenj√∂r','kvalitet','underh√•ll','skiftledare','kontakt','telefon','mail','email','roll','ansvar',
      'arbetsuppgift','personal','ledningsstruktur','organisation','org','hierarki','rapporterar'
    ];
    function isLinjeRelated(query) {
      const lowerQuery = LC(query||'');
      const kw = linjeKeywords.some(kw => lowerQuery.includes(kw));
      // nytt: linje-relaterat √§ven om du s√§ger bara "oscar" etc (via cache)
      const toks = lowerQuery.split(/\s+/).filter(Boolean);
      const namey = toks.some(t => PERSON_INDEX.first.has(t) || PERSON_INDEX.last.has(t) || !!closestFirstName(t));
      return kw || namey;
    }

    // Namn-korrigering (fuzzy) f√∂r r√∂st
    function correctNamesInQuery(q){
      const words = q.split(/\s+/);
      let changed=false;
      const out = words.map(w=>{
        const bare = w.replace(/[^A-Za-z√Ö√Ñ√ñ√•√§√∂\-]/g,'');
        if (bare.length<3) return w;
        const c = closestFirstName(bare);
        if (c && c!==LC(bare)){ changed=true; return w.replace(bare, c[0].toUpperCase()+c.slice(1)); }
        return w;
      });
      if (changed) append(pill(`üé§ Namn-korrigering: "${q}" ‚Üí "${out.join(' ')}"`));
      return out.join(' ');
    }

    // ===== mic viz =====
    let micAnalyser, micData;
    function setupMicViz(stream){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const src=ctx.createMediaStreamSource(stream);
        micAnalyser=ctx.createAnalyser(); micAnalyser.fftSize=512; micAnalyser.smoothingTimeConstant=0.8;
        src.connect(micAnalyser); micData=new Uint8Array(micAnalyser.frequencyBinCount);
        const bar=$('#micBar');
        (function loop(){
          if(!micAnalyser) return;
          micAnalyser.getByteTimeDomainData(micData);
          let peak=0; for(let i=0;i<micData.length;i++){ const v=Math.abs(micData[i]-128)/128; if(v>peak) peak=v; }
          bar.style.width=Math.min(98,(peak*100*1.6)+6)+'%';
          requestAnimationFrame(loop);
        })();
      }catch{}
    }

    // ===== logging (tyst) =====
    async function logMsg(role, content, modality='voice', payload=null){
      if(!rt.conversation_id) return;
      try{
        const res=await fetch('/api/memory-log',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversation_id:rt.conversation_id,role,content,modality,payload})});
        if(!res.ok) console.warn('LOGGNING FEL:', await res.text());
        rt._msgCount=(rt._msgCount||0)+1;
        if(rt._msgCount%8===0){
          fetch('/api/memory-summarize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversation_id:rt.conversation_id})})
            .then(()=>$('#memStatus').textContent='Minne: uppdaterat').catch(()=>{});
        }
      }catch(e){ console.warn('LOGGNING FEL:', e?.message||e); }
    }

    // ===== Realtime connect =====
    $('#rtBtn').addEventListener('click', connectRealtime);
    $('#rtHangup').addEventListener('click', hangupRealtime);

    async function connectRealtime(){
      const status=t=>$('#rtStatus').textContent=t;
      try{
        rt.mic = await navigator.mediaDevices.getUserMedia({
          audio: { channelCount: 1, noiseSuppression: true, echoCancellation: true, autoGainControl: false, sampleRate: 48000 }
        });
        setupMicViz(rt.mic);

        const memInit=await fetchJSON('/api/memory-init',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:localStorage.getItem('operator_id')||'kevin'})});
        rt.conversation_id=memInit.conversation_id; $('#memStatus').textContent='Minne: laddat';
        // Bygg namnindex (g√∂r r√∂st = text)
        buildPersonnelCache().catch(()=>{});

        rt.pc=new RTCPeerConnection();
        rt.pc.addTransceiver('audio', { direction:'recvonly' });
        rt.mic.getTracks().forEach(t=>rt.pc.addTrack(t,rt.mic));

        rt.remoteAudio=new Audio();
        rt.remoteAudio.autoplay=true; rt.remoteAudio.playsInline=true; rt.remoteAudio.muted=false;
        rt.pc.ontrack=e=>{ rt.remoteAudio.srcObject=e.streams[0]; rt.remoteAudio.play().catch(()=>{}); append(pill('üîä Mottar r√∂st fr√•n assistenten')); };

        rt.dc=rt.pc.createDataChannel('oai-events');
        rt.dc.onopen=()=>{ 
          rt.dc.send(JSON.stringify({
            type:'session.update',
            session:{
              voice:'verse',
              modalities:['audio','text'],
              turn_detection:{ type:'server_vad', threshold: 0.6, silence_duration_ms: 550, prefix_padding_ms: 200 },
              input_audio_transcription: { model: "gpt-4o-transcribe", language: "sv" },
              tool_choice:'auto',
              instructions:`
Du √§r Coach Assistant f√∂r Linje 65. F√∂r person/roll/hierarki-fr√•gor: sl√• endast i manualen och gissa aldrig.
Om m√∂jligt, begr√§nsa s√∂kningen till rubrikerna "Personal", "Ledning" eller "Organisation". L√§s upp exakt fr√•n manualen.
`.trim(),
              tools:[{
                type:'function', name:'search_manual',
                description:`S√∂k i manualen med st√∂d f√∂r rubrikfilter.`,
                parameters:{ type:'object', properties:{
                  query:{type:'string'}, k:{type:'integer',default:5}, minSim:{type:'number',default:0.45},
                  heading:{type:'string'}, restrictToHeading:{type:'boolean'}
                }, required:['query'] }
              }]
            }
          }));
          append(pill('Realtime ansluten. Prata n√§r som helst.'));
        };
        rt.dc.onmessage=(e)=>{ try{ handleRealtimeMessage(JSON.parse(e.data)); }catch{} };

        const {token, model}=await fetchJSON('/api/rt-token');
        append(pill('Realtime modell: '+model));
        const offer=await rt.pc.createOffer(); await rt.pc.setLocalDescription(offer);
        const sdp=await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}`,{
          method:'POST', headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/sdp','OpenAI-Beta':'realtime=v1'}, body:offer.sdp
        }).then(r=>r.text());
        await rt.pc.setRemoteDescription({type:'answer', sdp});

        rt.connected=true; $('#rtBtn').style.display='none'; $('#rtHangup').style.display='inline-block'; status('Realtime ansluten');
      }catch(e){ console.error(e); $('#rtStatus').textContent=`Realtime misslyckades: ${e?.message||e}`; append(errorBubble('Fel vid anslutning: '+(e?.message||e))); }
    }

    async function hangupRealtime(){
      try{
        rt.dc?.close(); rt.pc?.getSenders()?.forEach(s=>s.track?.stop()); rt.pc?.close(); rt.mic?.getTracks()?.forEach(t=>t.stop()); micAnalyser=null;
      }catch{}
      rt={ pc:null, dc:null, mic:null, remoteAudio:null, connected:false,
           conversation_id:rt.conversation_id, _msgCount:rt._msgCount,
           _ragBusy:false, _lastQuery:"", _lastToolCallId:null,
           cancelAutos:false, skipCancelForNextCreate:false, allowedResponseIds:new Set(),
           _lastUserText:"", _liveUserBuf:"", _pendingTool:null };
      $('#rtBtn').style.display='inline-block'; $('#rtHangup').style.display='none'; $('#rtStatus').textContent='Inte ansluten'; append(pill('Samtal avslutat.'));
    }

    // ===== Common parse helpers =====
    function extractUserTextFromItem(item){
      try{
        if(!item || item.type!=='message' || item.role!=='user') return '';
        const parts=item.content||[];
        for(const p of parts){
          if (p?.type==='input_text' && typeof p.text==='string') return p.text;
          if (p?.type==='text' && typeof p.text==='string') return p.text;
          if (p?.type==='input_audio_transcription' && typeof p.text==='string') return p.text;
          if (typeof p?.transcript==='string') return p.transcript;
        }
      }catch{}
      return '';
    }
    function extractAssistantTextFromItem(item){
      try{
        if(!item || item.type!=='message' || item.role!=='assistant') return '';
        const parts=item.content||[];
        for(const p of parts){
          if(p?.type==='output_text' && p?.text) return p.text;
          if(p?.type==='text' && p?.text) return p.text;
        }
      }catch{}
      return '';
    }

    // ===== Rubrik-rerank & kaskad =====
    function rerankByHeading(snippets, heading){
      const h = LC(heading);
      const pri=[], sec=[];
      for (const sn of (snippets||[])){
        const title = LC(sn.title||'');
        const path  = LC(sn.h_path||sn.section||'');
        const text  = LC(sn.text||'');
        (title.includes(h) || path.includes(h) || text.includes(h)) ? pri.push(sn) : sec.push(sn);
      }
      return { hits: [...pri, ...sec], priCount: pri.length };
    }

    async function manualSearchCascade({query,k,minSim,headingHint}){
      if (headingHint){
        const d=await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,k,topK:k,minSim,heading:headingHint,restrictToHeading:true})});
        let hits = d.snippets||[]; let priCount=0;
        const rr = rerankByHeading(hits, headingHint); hits=rr.hits; priCount=rr.priCount;
        if (priCount>0) hits = hits.filter(sn => LC(sn.title||'').includes(LC(headingHint)) || LC(sn.h_path||'').includes(LC(headingHint)) || LC(sn.text||'').includes(LC(headingHint)));
        if (hits.length) return {hits, meta:{from:'explicit', heading:headingHint, priCount, fallback:d.fallback}};
      }
      for (const h of HEADING_CANDIDATES){
        const d=await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,k,topK:k,minSim,heading:h,restrictToHeading:true})});
        let hits = d.snippets||[]; let priCount=0;
        const rr = rerankByHeading(hits, h); hits=rr.hits; priCount=rr.priCount;
        if (priCount>0) hits = hits.filter(sn => LC(sn.title||'').includes(LC(h)) || LC(sn.h_path||'').includes(LC(h)) || LC(sn.text||'').includes(LC(h)));
        if (hits.length) return {hits, meta:{from:'cascade', heading:h, priCount, fallback:d.fallback}};
      }
      const d = await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query,k,topK:k,minSim,heading:null,restrictToHeading:false})});
      return {hits:d.snippets||[], meta:{from:'fallback', heading:null, priCount:0, fallback:d.fallback}};
    }

    // ===== Person & hierarki extraktion =====
    function extractHierarchy(snippets){
      const results=[];
      for (const sn of (snippets||[])){
        const text=(sn.text||'').replace(/\s+/g,' ').trim();
        const sentences=text.split(/(?<=[\.\!\?:;])\s+/);
        let lastName=null;
        for (const s of sentences){
          const names = [...s.matchAll(/\b([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b/g)].map(m=>m[1]);
          if (names.length) lastName = names[names.length-1];

          const m1 = s.match(/\b([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b.*?√§r\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)s?\s+chef\b/i);
          if (m1){ results.push({manager:m1[1], subordinate:m1[2], sentence:s, sn}); continue; }

          const m1b = s.match(/\b(Han|Hon)\s+√§r\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)s?\s+chef\b/i);
          if (m1b && lastName){ results.push({manager:lastName, subordinate:m1b[2], sentence:s, sn}); continue; }

          const m2 = s.match(/\b([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b.*?rapporterar\s+(?:direkt\s+)?till\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b/i);
          if (m2){ results.push({subordinate:m2[1], manager:m2[2], sentence:s, sn}); continue; }

          const m2b = s.match(/\b(Han|Hon)\s+rapporterar\s+(?:direkt\s+)?till\s+([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b/i);
          if (m2b && lastName){ results.push({subordinate:lastName, manager:m2b[2], sentence:s, sn}); continue; }

          const m3 = s.match(/\b([A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+)\b.*?√§r\s+chef\s+(√∂ver|f√∂r)\s+(operat√∂r(?:erna|er)?|linjen|teamet)\b/i);
          if (m3){ results.push({manager:m3[1], team:m3[3], sentence:s, sn}); continue; }
        }
      }
      let best=null; for (const r of results){ let sc=(r.sn?.score||0); if (r.subordinate && r.manager) sc+=0.2; if (r.team) sc+=0.12; if (r.sentence.length<120) sc+=0.05; if (!best||sc>(best._sc||-1)){ best=r; best._sc=sc; } }
      return best;
    }

    function extractPersonAnswer(snippets){
      let best=null;
      function scoreLine(line, baseScore){
        const L = LC(line); let sc = baseScore || 0;
        if (/ansvar|uppgift|chef|rollen/.test(L)) sc += 0.06;
        if (/\b[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+(?:\s+[A-Z√Ö√Ñ√ñ][a-z√•√§√∂]+)+\b/.test(line)) sc += 0.14;
        if (line.length<18) sc -= 0.06;
        return sc;
      }
      for (const sn of (snippets||[])){
        const base = sn.score || 0;
        const lines = (sn.text||'').split(/\n+/).concat((sn.text||'').split(/(?<=[\.\!\?:;])\s+/));
        for (const ln of lines){
          const sc = scoreLine(ln, base);
          if (!best || sc>best.sc) best={line:ln.trim(), sn, sc};
        }
      }
      if (!best) return null;
      return { sentence: best.line.replace(/\s+/g,' ').trim(), src: best.sn };
    }

    // ===== Realtime events =====
    function handleRealtimeMessage(msg){
      if (msg.type==='conversation.item.created'){
        if (msg.item?.role==='user'){
          let utext = extractUserTextFromItem(msg.item).trim();
          if (utext){
            // r√∂st: korrigera namn innan n√•got annat
            utext = correctNamesInQuery(utext);
            rt._lastUserText = utext; rt._liveUserBuf = '';
            append(bubble(utext,'user')); logMsg('user',utext,'voice',msg);
            if (rt._pendingTool){ tryRunPending('final'); return; }
            if (RAG_ON_CREATED && isLinjeRelated(utext) && !rt._ragBusy && utext!==rt._lastQuery){
              rt._ragBusy=true; rt._lastQuery=utext; rt.cancelAutos=true; clearTimeout(ragTimer);
              ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
              runToolSearchManual({tool_call_id:null,response_id:null,argsText:JSON.stringify({query:utext,k:5,minSim:TEXT_MIN_SIM, voice:false})}).finally(()=>{});
            }
          }
        }
        const atext = extractAssistantTextFromItem(msg.item);
        if (atext){ append(bubble(atext,'assistant')); logMsg('assistant',atext,'voice',msg); }
      }

      if (msg.type==='conversation.item.input_audio_transcription.delta'){
        const chunk = msg.delta || msg.text || msg.transcript || '';
        if (chunk) rt._liveUserBuf = (rt._liveUserBuf||'') + chunk;
        return;
      }
      if (msg.type==='conversation.item.input_audio_transcription.completed'){
        let full = (msg.transcript?.text || msg.text || msg.transcript || '').trim();
        if (full){
          full = correctNamesInQuery(full);
          rt._lastUserText = full; rt._liveUserBuf = '';
          append(bubble(full,'user')); logMsg('user',full,'voice',msg);
          if ((isLinjeRelated(full) || isPersonnelQuery(full)) && !rt._ragBusy && full!==rt._lastQuery){
            rt._ragBusy=true; rt._lastQuery=full; rt.cancelAutos=true; clearTimeout(ragTimer);
            ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
            runToolSearchManual({tool_call_id:null,response_id:null,argsText:JSON.stringify({query:full,k:5,minSim:VOICE_MIN_SIM, voice:true})}).finally(()=>{});
          }
        }
        return;
      }

      if (msg.type==='response.function_call_arguments.delta'){
        const id=msg.id||msg.tool_call_id||msg.response_id||'unknown';
        const prev=toolCalls.get(id)||{name:msg.name,argsText:''};
        prev.argsText+=(msg.delta||msg.arguments_delta||'');
        prev.name=prev.name||msg.name;
        if (msg.response_id) prev.response_id=msg.response_id;
        toolCalls.set(id,prev);
        return;
      }

      if (msg.type==='response.created'){
        const rid=msg.response?.id||msg.response_id;
        if (rid && rt.allowedResponseIds.has(rid)) return;
        if (rt._ragBusy || rt.cancelAutos){
          if (rid){ rt.dc?.send(JSON.stringify({type:'response.cancel', response_id:rid})); append(pill('üõë Auto-respons stoppad')); return; }
        }
        return;
      }

      if (msg.type==='response.function_call_arguments.done'){
        const id=msg.id||msg.tool_call_id||'unknown';
        const tc=toolCalls.get(id)||{name:msg.name,argsText:''};
        if (msg.response_id){ tc.response_id=msg.response_id; toolCalls.set(id,tc); }
        let args={}; try{ args=JSON.parse(tc.argsText||'{}'); }catch{}
        if (tc.name){ const shown=(args.query||'').slice(0,32); append(pill(`TOOL CALL ‚Üí ${tc.name} q="${shown}${(args.query||'').length>32?'‚Ä¶':''}"`)); }

        if (tc.name==='search_manual'){
          const qNow=(args.query||rt._lastUserText||'').trim();
          if (!qNow){ parkPendingTool({id, argsText: tc.argsText, response_id: tc.response_id}); append(pill('‚è≥ V√§ntar p√• transkript (max 2s)')); return; }
          if (rt._ragBusy || tc.launched) return;
          tc.launched=true; toolCalls.set(id,tc);
          rt.cancelAutos=true; if (tc.response_id) rt.allowedResponseIds.add(tc.response_id);
          rt._ragBusy=true; rt._lastToolCallId=id; clearTimeout(ragTimer);
          ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
          const patchedArgs=JSON.stringify({...args, query:qNow});
          return runToolSearchManual({tool_call_id:id,response_id:tc.response_id,argsText:patchedArgs}).finally(()=>{});
        }
      }

      if (msg.type==='response.output_text.done'){
        const text=msg.output_text||msg.text||'';
        if (text?.trim()){ append(bubble(text,'assistant')); logMsg('assistant',text,'voice',msg); }
        rt._ragBusy=false; rt.cancelAutos=false; rt.skipCancelForNextCreate=false;
        if (msg.response_id) rt.allowedResponseIds.delete(msg.response_id);
        clearTimeout(ragTimer); return;
      }

      if (msg.type==='response.completed' || msg.type==='response.error' || msg.type==='error'){
        rt._ragBusy=false; rt.cancelAutos=false; rt.skipCancelForNextCreate=false;
        if (msg.response_id) rt.allowedResponseIds.delete(msg.response_id);
        clearTimeout(ragTimer); return;
      }
    }

    function parkPendingTool({id,argsText,response_id}){
      rt._pendingTool = { id, argsText, response_id, deadline: Date.now()+WAIT_FOR_QUERY_MS, interval: rt._pendingTool?.interval || null };
      if (!rt._pendingTool.interval){ rt._pendingTool.interval = setInterval(()=> tryRunPending(), 150); }
    }
    function tryRunPending(){
      const p = rt._pendingTool; if (!p) return;
      let args={}; try{ args=JSON.parse(p.argsText||'{}'); }catch{}
      const q = (args.query||rt._lastUserText||'').trim();
      if (q){
        clearInterval(p.interval); rt._pendingTool=null;
        rt.cancelAutos = true; if (p.response_id) rt.allowedResponseIds.add(p.response_id);
        rt._ragBusy = true; rt._lastToolCallId = p.id; clearTimeout(ragTimer);
        ragTimer = setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
        const patchedArgs = JSON.stringify({...args, query:q});
        append(pill('üîÅ K√∂r parkerad s√∂kning'));
        runToolSearchManual({tool_call_id:p.id,response_id:p.response_id,argsText:patchedArgs}).finally(()=>{});
        return;
      }
      if (Date.now() > p.deadline){
        clearInterval(p.interval); rt._pendingTool=null;
        rt.cancelAutos=false; if (p.response_id) rt.allowedResponseIds.add(p.response_id);
        rt.dc?.send(JSON.stringify({ type:'conversation.item.create', item:{ type:'function_call_output', call_id:p.id, output: JSON.stringify({ ok:false, error:'missing_query_timeout', need_user:true }) }}));
        rt.skipCancelForNextCreate = true; rt.dc?.send(JSON.stringify({ type:'response.create' })); append(pill('‚åõ Timeout: inget transkript att s√∂ka p√•'));
      }
    }

    // ===== Scoring helpers =====
    function isNumericQuestion(q){ const s=(q||'').toLowerCase(); return /\b(hur m√•nga|antal(?:et)?|how many|number of|count)\b/.test(s); }
    function hasAll(words,text){ const low=text.toLowerCase(); return words.every(w=>low.includes(w.toLowerCase())); }
    function extractNumericAnswer(snippets, keywordsAny=[], keywordsMust=[]){
      let best=null;
      for(const sn of (snippets||[])){
        const text=(sn.text||'').replace(/\s+/g,' ').trim();
        const sentences=text.split(/(?<=[\.\!\?:;])\s+/);
        for(const sent of sentences){
          const m=sent.match(/\b\d{1,4}(?:[.,]\d+)?\b/); if(!m) continue;
          if (keywordsMust.length && !hasAll(keywordsMust,sent)) continue;
          let sc=(sn.score||0); const low=sent.toLowerCase();
          for(const kw of keywordsAny) if(low.includes(kw.toLowerCase())) sc+=0.03;
          if (sent.length<20) sc-=0.1;
          if(!best || sc>best.sc) best={sent:sent.trim(), num:m[0], sn, sc};
        }
      }
      return best;
    }
    const DOMAIN_BOOST=['tapp','givare','sensor','ocme','fels√∂k','format','karusell','ventil','personal','chef','operat√∂r','ingenj√∂r'];

    function pickBestSentence(snippets, query){
      const q=(query||'').toLowerCase(); const tokens=q.split(/[^a-z√•√§√∂0-9]+/i).filter(t=>t.length>2);
      let best={s:'',score:-1,src:null};
      for(const sn of (snippets||[])){
        const text=(sn.text||'').replace(/\s+/g,' ').trim();
        const sentences=text.split(/(?<=[\.\!\?:;])\s+/);
        for(const sent of sentences){
          let sc=(sn.score||0); const low=sent.toLowerCase();
          if(/\d/.test(sent)) sc+=0.15;
          for(const t of tokens) if(low.includes(t)) sc+=0.04;
          for(const d of DOMAIN_BOOST) if(low.includes(d)) sc+=0.05;
          if(sent.length<25) sc-=0.1;
          if(sc>best.score) best={s:sent.trim(),score:sc,src:sn};
        }
      }
      return best;
    }

    function speakVerbatim(text){
      const toSay=`L√ÑS UPP EXAKT (ordagrant) och utan till√§gg: """${text}"""`;
      rt.skipCancelForNextCreate=true;
      const response = { modalities:['audio','text'], instructions:toSay, metadata:{source:'rag'} };
      if (STRICT_RAG){ response.tool_choice = { type:'function', name:'search_manual' }; }
      rt.dc?.send(JSON.stringify({ type:'response.create', response }));
    }

    // ===== Manual tool =====
    function parseArgsSafe(s){ try{ return JSON.parse(s||'{}'); }catch{ return {}; } }

    async function runToolSearchManual(tc){
      const args=parseArgsSafe(tc.argsText);
      const k=args.k??5;
      let q=(args.query||rt._lastUserText||'').trim();

      if(!q){
        if(tc.tool_call_id){
          rt.dc?.send(JSON.stringify({ type:'conversation.item.create', item:{ type:'function_call_output', call_id:tc.tool_call_id, output: JSON.stringify({ok:false,error:'missing_query',need_user:true}) }}));
          rt.skipCancelForNextCreate = true; rt.dc?.send(JSON.stringify({ type:'response.create' })); append(pill('‚ö†Ô∏è search_manual: tom query ‚Üí be om f√∂rtydligande'));
        }else{ speakVerbatim('Jag uppfattade inte fr√•gan. Kan du s√§ga den igen?'); }
        rt._ragBusy=false; clearTimeout(ragTimer); return;
      }

      // Namn-korrigering en g√•ng till (om tool kallats av modellen direkt)
      q = correctNamesInQuery(q);

      const personQ = isPersonnelQuery(q);
      const headingHint = personQ ? 'Personal' : null;
      const minSimBase = (typeof args.minSim==='number' ? args.minSim : (args.voice ? VOICE_MIN_SIM : TEXT_MIN_SIM));
      const minSim = personQ ? Math.min(minSimBase, PERSON_MIN_SIM) : minSimBase;

      const {hits, meta} = await manualSearchCascade({ query:q, k, minSim, headingHint });
      append(pill(`RAG: count=${hits.length}${meta.fallback?' (fallback)':''} ‚Ä¢ top1=${(hits[0]?.score??0).toFixed(2)}${meta.heading?` ‚Ä¢ rubrik="${meta.heading}" match:${meta.priCount}`:''} ‚Ä¢ q="${q.slice(0,32)}${q.length>32?'‚Ä¶':''}"`));

      let strict='', bestSent='', numeric=null;

      if (personQ && hits.length){
        const h = extractHierarchy(hits);
        if (h?.sentence){
          if (h.subordinate && h.manager) strict = `Enligt manualen: ${h.subordinate} rapporterar till ${h.manager}.`;
          else if (h.manager && h.team)   strict = `Enligt manualen: ${h.manager} √§r chef √∂ver ${h.team}.`;
          else strict = `Enligt manualen: ${h.sentence}`;
        }
        if (!strict){
          const person = extractPersonAnswer(hits);
          if (person?.sentence) strict = `Enligt manualen: ${person.sentence}`;
        }
      }

      if (!strict){
        if (isNumericQuestion(q)){
          const hit=extractNumericAnswer(hits, ['givare','sensor'], ['tapp']);
          if (hit?.sent){ strict=`Enligt manualen: ${hit.sent}`; bestSent=hit.sent; numeric={value:Number((hit.num||'').replace(',','.')), sentence:hit.sent}; }
        }
      }
      if (!strict && hits.length){
        const pick=pickBestSentence(hits,q);
        bestSent=(pick.s || (hits[0].text||'').replace(/\s+/g,' ').trim()).slice(0,500);
        strict=`Enligt manualen: ${bestSent}`;
      }
      if (!strict){
        strict = personQ ? 'Jag hittar ingen uppgift om det i organisationsavsnittet i manualen.' : 'Jag har tyv√§rr inte l√§rt mig det √§nnu fr√•n manualen ‚Äì kan du f√∂rtydliga?';
      }

      const sources=(hits||[]).slice(0,5).map(s=>({title:s.title||'manual',idx:s.idx,score:s.score}));
      const out={ ok:true, strict_answer:strict||undefined, best_sentence:bestSent||undefined, numeric:numeric||null, fallback:!!meta.fallback, top_score:(hits[0]?.score??null), sources };

      if (tc.tool_call_id){
        rt.dc?.send(JSON.stringify({ type:'conversation.item.create', item:{ type:'function_call_output', call_id:tc.tool_call_id, output: JSON.stringify(out) }}));
        rt.skipCancelForNextCreate = true; rt.dc?.send(JSON.stringify({ type:'response.create' })); append(pill('üì§ Skickade tool-output till modellen'));
      } else {
        speakVerbatim(out.strict_answer || 'Jag kan inte verifiera det i manualen just nu.');
        if (out.strict_answer){
          const s0=sources[0]||{}; append(bubble(`${out.strict_answer}\nH√§mtat fr√•n: ${(s0.title||'manual')} ‚Ä¢ idx:${s0.idx??'?'} ‚Ä¢ score:${(s0.score??0).toFixed(2)}`,'assistant'));
        }
      }

      rt._ragBusy=false; rt.cancelAutos=false; clearTimeout(ragTimer);
    }

    // ===== Manual text send =====
    $('#sendTextBtn').onclick = sendQuickText;
    $('#quickText').addEventListener('keydown', e => { if(e.key==='Enter') sendQuickText(); });
    function sendQuickText(){
      const t=$('#quickText').value.trim(); if(!t) return;
      $('#quickText').value='';
      const corrected = correctNamesInQuery(t);
      append(bubble('‚û§ '+corrected,'user')); rt._lastUserText=corrected; sendTextToRealtime(corrected);
    }
    function sendTextToRealtime(text){
      if(!rt?.dc || rt.dc.readyState!=='open'){ append(pill('Inte ansluten.')); return; }
      rt.dc.send(JSON.stringify({type:'input_text', text}));
      if ((isLinjeRelated(text) || isPersonnelQuery(text)) && !rt._ragBusy && text!==rt._lastQuery){
        rt._ragBusy=true; rt._lastQuery=text; rt.cancelAutos=true; clearTimeout(ragTimer);
        ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
        runToolSearchManual({tool_call_id:null,response_id:null,argsText:JSON.stringify({query:text,k:5,minSim:TEXT_MIN_SIM, voice:false})}).finally(()=>{});
      }
    }

    // ===== Manual test UI =====
    $('#manualBtn').addEventListener('click', testManualSearch);
    $('#manualQuery').addEventListener('keydown', e => { if(e.key==='Enter') testManualSearch(); });
    async function testManualSearch(){
      const q0=$('#manualQuery').value.trim(); if(!q0){ append(pill('Skriv en fr√•ga f√∂r manualen.')); return; }
      const q = correctNamesInQuery(q0);
      append(bubble('üîé Manual: '+q,'user'));
      try{
        const personQ = isPersonnelQuery(q);
        const minSim  = personQ ? PERSON_MIN_SIM : TEXT_MIN_SIM;
        const {hits, meta} = await manualSearchCascade({ query:q, k:5, minSim, headingHint: personQ?'Personal':null });

        append(pill(`RAG: count=${hits.length}${meta.fallback?' (fallback)':''} ‚Ä¢ top1=${(hits[0]?.score??0).toFixed(2)}${meta.heading?` ‚Ä¢ rubrik="${meta.heading}" match:${meta.priCount}`:''}`));
        if(!hits.length){ append(bubble(personQ?'Inget i organisationsavsnittet.':'Inga tr√§ffar i manualen.','assistant')); return; }

        if (personQ){
          const h = extractHierarchy(hits);
          if (h?.sentence){
            if (h.subordinate && h.manager){ append(bubble(`Enligt manualen: ${h.subordinate} rapporterar till ${h.manager}.`,'assistant')); return; }
            if (h.manager && h.team){ append(bubble(`Enligt manualen: ${h.manager} √§r chef √∂ver ${h.team}.`,'assistant')); return; }
            append(bubble(`Enligt manualen: ${h.sentence}`,'assistant')); return;
          }
          const person = extractPersonAnswer(hits);
          if (person?.sentence){ append(bubble(`Enligt manualen: ${person.sentence}`,'assistant')); return; }
          append(bubble('Hittar ingen tydlig rad med namn/roll i organisationsavsnittet.','assistant')); return;
        }

        const isNum=/\b(hur m√•nga|antal(?:et)?|how many|number of|count)\b/i.test(q);
        if(isNum){
          const hit=extractNumericAnswer(hits,['givare','sensor'],['tapp']);
          if(hit?.sent){ append(bubble(`Enligt manualen: ${hit.sent}\nH√§mtat fr√•n: ${(hit.sn?.title||'manual')} ‚Ä¢ idx:${hit.sn?.idx??'?'} ‚Ä¢ score:${(hit.sn?.score??0).toFixed(2)}`,'assistant')); }
          else { append(bubble('Kan inte verifiera exakt antal i manualen f√∂r denna fr√•ga. Specificera del/omr√•de eller felkod s√• s√∂ker jag igen.','assistant')); }
        }else{
          const pick=pickBestSentence(hits,q);
          const top=pick.src||hits[0];
          const chosen=(pick.s||(top.text||'').replace(/\s+/g,' ').trim()).slice(0,500);
          append(bubble(`${chosen}\nH√§mtat fr√•n: ${(top.title||'manual')} ‚Ä¢ idx:${top.idx??'?'} ‚Ä¢ score:${(top.score??0).toFixed(2)}`,'assistant'));
        }
      }catch(e){ append(errorBubble('Manual-s√∂k fel: '+e.message)); }
    }
  </script>
</body>
</html>
