<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ¦¾ Coach Assistant â€“ Linje 65 (Realtime)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
    button { margin: 5px; }
    #status { font-weight: bold; }
    #memory { margin-top: 10px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
    #input { width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ¦¾ Coach Assistant â€“ Linje 65 (Realtime)</h1>

  <div>
    <label>OperatÃ¶r:</label>
    <input type="text" id="operator" placeholder="Spara">
    <button id="save-operator">Spara</button>
  </div>

  <button id="connect">Anslut Realtime</button>
  <button id="disconnect">LÃ¤gg pÃ¥</button>

  <p id="status">Inte ansluten</p>
  <p id="memory">Minne: â€”</p>

  <div id="chat"></div>

  <textarea id="input" placeholder="Skriv meddelande..."></textarea>
  <button id="send">Skicka</button>

  <button id="test-manual">Testa manual</button>

  <footer>Realtime-rÃ¶st med WebRTC. Manual/RAG via Supabase. Logg + minne i Supabase.</footer>

  <script>
    let ws = null;
    let mediaRecorder = null;
    let stream = null;
    let token = null;
    let model = null;
    const chatDiv = document.getElementById('chat');
    const status = document.getElementById('status');
    const memory = document.getElementById('memory');
    const input = document.getElementById('input');
    const connectBtn = document.getElementById('connect');
    const disconnectBtn = document.getElementById('disconnect');
    const sendBtn = document.getElementById('send');
    const testBtn = document.getElementById('test-manual');

    // HÃ¤mta token frÃ¥n server
    async function getToken() {
      const res = await fetch('/api/rt-token');
      const data = await res.json();
      if (data.error) {
        console.error('Token error:', data.error);
        status.textContent = 'Fel vid token-hÃ¤mtning';
        return null;
      }
      token = data.token;
      model = data.model;
      return token;
    }

    // Anslut WebSocket
    async function connectRealtime() {
      if (!token) await getToken();
      if (!token) return;

      ws = new WebSocket(`wss://api.openai.com/v1/realtime?model=${model}`, ['openai-realtime', token]);

      ws.onopen = () => {
        status.textContent = 'Ansluten';
        // Uppdatera session fÃ¶r turn_detection
        ws.send(JSON.stringify({
          type: 'session.update',
          session: {
            turn_detection: { type: 'server_vad' }  // BÃ¤ttre detektion av tal-slut
          }
        }));
        startAudio();
      };

      ws.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        console.log('WS message:', data);

        if (data.type === 'response.audio.delta' || data.type === 'response.audio') {
          // Spela upp audio-svar (base64 till blob)
          const audioData = data.delta || data.audio;
          const audioBlob = new Blob([Uint8Array.from(atob(audioData), c => c.charCodeAt(0))], { type: 'audio/wav' });
          const audio = new Audio(URL.createObjectURL(audioBlob));
          audio.play();
          addToChat('Assistant (rÃ¶st): Svar spelas upp...');
        } else if (data.type === 'response.text.delta' || data.type === 'response.text') {
          addToChat(`Assistant (text): ${data.delta || data.text}`);
        } else if (data.type === 'response.function_call') {
          // Hantera tool call!
          const toolName = data.name;
          if (toolName === 'search_manual') {
            const args = JSON.parse(data.arguments);  // { query: '...', k: 5, minSim: 0.45 }
            console.log('Tool call args:', args);
            status.textContent = 'SÃ¶ker i manualen...';
            try {
              const response = await fetch('/api/search-manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(args)
              });
              const result = await response.json();
              console.log('Tool result:', result);
              // Skicka tillbaka till session
              ws.send(JSON.stringify({
                type: 'session.tool_result',
                tool_call_id: data.id,
                result: JSON.stringify(result)  // Hela resultatet, inklusive snippets
              }));
              addToChat('Manual-sÃ¶k: Hittade ' + result.count + ' resultat.');
            } catch (err) {
              console.error('Tool error:', err);
              ws.send(JSON.stringify({
                type: 'session.tool_result',
                tool_call_id: data.id,
                result: JSON.stringify({ error: err.message })
              }));
            }
          }
        } else if (data.type === 'error') {
          console.error('WS error:', data.error);
          status.textContent = 'Fel: ' + data.error.message;
        }
      };

      ws.onclose = () => {
        status.textContent = 'FrÃ¥nkopplad';
        stopAudio();
      };
    }

    // Starta audio-inspelning
    async function startAudio() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(e.data);  // Skicka audio-chunks direkt
          }
        };
        mediaRecorder.start(250);  // Skicka var 250ms
        status.textContent = 'Lyssnar...';
      } catch (err) {
        console.error('Audio error:', err);
        status.textContent = 'Kan inte starta audio';
      }
    }

    // Stoppa audio
    function stopAudio() {
      if (mediaRecorder) mediaRecorder.stop();
      if (stream) stream.getTracks().forEach(track => track.stop());
    }

    // LÃ¤gg till meddelande i chat
    function addToChat(msg) {
      const p = document.createElement('p');
      p.textContent = msg;
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    // Event listeners
    connectBtn.addEventListener('click', connectRealtime);
    disconnectBtn.addEventListener('click', () => {
      if (ws) ws.close();
    });
    sendBtn.addEventListener('click', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'input.text',
          text: input.value
        }));
        addToChat('Du (text): ' + input.value);
        input.value = '';
      }
    });
    testBtn.addEventListener('click', async () => {
      // Testa manual-sÃ¶k manuellt
      const query = prompt('Ange sÃ¶kfrÃ¥ga fÃ¶r manual:');
      if (query) {
        const res = await fetch('/api/search-manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, k: 5, minSim: 0.45 })
        });
        const data = await res.json();
        addToChat('Manual-test: ' + JSON.stringify(data, null, 2));
      }
    });

    // Spara operator (exempel, anpassa till Supabase)
    document.getElementById('save-operator').addEventListener('click', () => {
      const op = document.getElementById('operator').value;
      console.log('Sparar operator:', op);
      // TODO: Skicka till Supabase
    });
  </script>
</body>
</html>
