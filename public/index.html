<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coach Assistant ‚Äì Linje 65 (Realtime)</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121821;--text:#e6edf3;--muted:#9fb0c2;--accent:#5eead4;--danger:#f87171;--ok:#86efac;--pill:#182232}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:radial-gradient(1200px 600px at 20% 0%,#0e1621,#0b0f14 75%);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    header .title{font-size:20px;font-weight:700;letter-spacing:.3px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .primary{background:var(--accent);color:#0a0f14}
    .ghost{background:#0d1520;color:var(--text);border:1px solid #233146}
    .danger{background:var(--danger);color:#111}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center}
    input[type="text"],input[type="search"]{background:#0d1622;color:var(--text);outline:none;border:1px solid #243244;border-radius:10px;padding:10px 12px}
    .pill{background:var(--pill);color:var(--text);padding:8px 12px;border-radius:999px;display:inline-block;margin:6px 6px 0 0;font-size:12px;border:1px solid #26364a}
    .panel{background:var(--panel);border:1px solid #233146;border-radius:16px;padding:14px}
    #output{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .bubble{background:#0f1722;border:1px solid #213145;border-radius:16px;padding:12px 14px;white-space:pre-wrap;line-height:1.45}
    .bubble.user{background:#0f1a27;border-color:#24415a}
    .bubble.assistant{background:#0f1823;border-color:#2c3f57}
    .bubble.error{background:#1b0f12;border-color:#4a1f2a}
    .vis{height:10px;background:#0e1420;border-radius:9999px;overflow:hidden;border:1px solid #213145}
    .vis>b{display:block;height:100%;width:6%;background:linear-gradient(90deg,#85f3d5,#4dd4ff);transition:width .08s linear}
    footer{margin-top:24px;color:var(--muted);font-size:12px}
    .src{font-size:12px;margin-top:6px;color:#bfd7ff;opacity:.9}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ü¶æ Coach Assistant ‚Äì Linje 65 (Realtime)</div>
      <div class="controls">
        <div class="row">
          <label class="muted" for="operatorId">Operat√∂r:</label>
          <input id="operatorId" type="text" placeholder="t.ex. kevin" style="width:140px" />
        </div>
        <div class="row">
          <button class="primary" id="rtBtn">Anslut Realtime</button>
          <button class="danger" id="rtHangup" style="display:none">L√§gg p√•</button>
          <span id="rtStatus" class="muted">Inte ansluten</span>
        </div>
        <div class="row">
          <div class="vis"><b id="micBar"></b></div>
          <span id="memStatus" class="muted">Minne: ‚Äì</span>
        </div>
      </div>
    </header>

    <div class="panel">
      <div class="row">
        <strong>Debug</strong>
        <div class="flex">
          <span class="muted">‚Ä¢ Realtime-status:</span>
          <span id="dbgRt" class="pill">‚Ä¶</span>
          <span class="muted">‚Ä¢ Autosvar avbryts:</span>
          <span id="dbgCancel" class="pill">false</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="quickText" type="search" placeholder="Skicka text till assistenten (enter)" style="flex:1" />
        <button class="ghost" id="sendTextBtn">Skicka</button>
      </div>

      <div class="row" style="margin-top:10px">
        <input id="manualQuery" type="search" placeholder="Testa manual-s√∂k (t.ex. 'hur m√•nga givare har tappen')" style="flex:1" />
        <button class="ghost" id="manualBtn">Testa manual</button>
      </div>

      <div id="output"></div>
    </div>

    <footer>
      Realtime-r√∂st med WebRTC. Manual/RAG via Supabase. Logg + minne i Supabase (conversations/messages/summary).
    </footer>
  </div>

  <script>
    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    async function fetchJSON(url, opts){ const r=await fetch(url,opts); const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j?.error||j?.message||`${r.status} ${r.statusText}`); return j; }
    const pill = t => { const d=document.createElement('div'); d.className='pill'; d.textContent=t; return d; };
    const bubble = (t,role='assistant') => { const d=document.createElement('div'); d.className='bubble '+role; d.textContent=t; return d; };
    const errorBubble = t => { const d=document.createElement('div'); d.className='bubble error'; d.textContent=t; return d; };
    const append = el => { $('#output').appendChild(el); el.scrollIntoView({behavior:'smooth',block:'end'}); };

    // ===== Operator =====
    const operatorInput = $('#operatorId');
    operatorInput.value = localStorage.getItem('operator_id') || 'kevin';
    operatorInput.addEventListener('change',()=> localStorage.setItem('operator_id', operatorInput.value.trim() || 'kevin'));

    // ===== State =====
    let rt = {
      pc:null, dc:null, mic:null, remoteAudio:null, connected:false,
      conversation_id:null,
      _msgCount:0, _ragBusy:false, _lastQuery:'', _lastToolCallId:null,
      cancelAutos:false, skipCancelForNextCreate:false, allowedResponseIds:new Set(),
      _lastUserText:'', _liveUserBuf:'',
      _pendingTool:null // {id,argsText,response_id,deadline,interval}
    };
    const toolCalls = new Map();
    const RAG_TIMEOUT_MS = 8000;
    const WAIT_FOR_QUERY_MS = 5000; // max v√§ntetid f√∂r att f√• text efter tomt tool-call
    let ragTimer = null;

    // silence fallback to finalize utterance when no explicit final event arrives
    let silenceTimer = null;
    function scheduleSilenceFinalizer(){
      clearTimeout(silenceTimer);
      silenceTimer = setTimeout(()=>{
        const text=(rt._liveUserBuf||'').trim();
        if(text && !rt._ragBusy && text!==rt._lastQuery){
          rt._ragBusy=true; rt._lastQuery=text; rt.cancelAutos=true; clearTimeout(ragTimer);
          ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
          runToolSearchManual({
            tool_call_id:null, response_id:null,
            argsText: JSON.stringify({query:text,k:5,minSim:0.55})
          }).finally(()=>{});
        }
      }, 900); // 0.9s silence
    }

    // mic viz
    let micAnalyser, micData;
    function setupMicViz(stream){
      try{
        const ctx=new (window.AudioContext||window.webkitAudioContext)();
        const src=ctx.createMediaStreamSource(stream);
        micAnalyser=ctx.createAnalyser(); micAnalyser.fftSize=512; micData=new Uint8Array(micAnalyser.frequencyBinCount);
        src.connect(micAnalyser);
        const bar=$('#micBar');
        const loop=()=>{ if(!micAnalyser) return; micAnalyser.getByteTimeDomainData(micData); let peak=0; for (let i=0;i<micData.length;i++){ peak=Math.max(peak, Math.abs(micData[i]-128)); } bar.style.width = Math.min(100, Math.max(6, peak*0.9))+'%'; requestAnimationFrame(loop); };
        loop();
      }catch{}
    }

    function speakVerbatim(text){
      // route via Realtime TTS (model speaks). Sending as assistant content ensures it's read out.
      if(!rt?.dc?.readyState || rt.dc.readyState!=='open') return;
      rt.dc.send(JSON.stringify({ type:'response.create', response:{ instructions: text } }));
    }

    function logMsg(role, content, mode='text', extra={}){
      try{
        fetch('/api/memory-log',{ method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ role, content, mode, conversation_id: rt.conversation_id, ...extra })
        }).catch(()=>{});
        rt._msgCount=(rt._msgCount||0)+1;
        if(rt._msgCount%8===0){ fetch('/api/memory-summarize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversation_id:rt.conversation_id})}).then(()=>$('#memStatus').textContent='Minne: uppdaterat').catch(()=>{}); }
      }catch(e){ console.warn('LOGGNING FEL:', e?.message||e); }
    }

    // ===== Realtime connect =====
    $('#rtBtn').addEventListener('click', connectRealtime);
    $('#rtHangup').addEventListener('click', hangupRealtime);

    async function connectRealtime(){
      const status=t=>$('#rtStatus').textContent=t;
      try{
        rt.mic=await navigator.mediaDevices.getUserMedia({audio:true}); setupMicViz(rt.mic);
        const memInit=await fetchJSON('/api/memory-init',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:localStorage.getItem('operator_id')||'kevin'})});
        rt.conversation_id=memInit.conversation_id; $('#memStatus').textContent='Minne: laddat';

        rt.pc=new RTCPeerConnection(); rt.mic.getTracks().forEach(t=>rt.pc.addTrack(t,rt.mic));
        rt.remoteAudio=new Audio(); rt.remoteAudio.autoplay=true; rt.remoteAudio.playsInline=true; rt.remoteAudio.muted=false;
        rt.pc.ontrack=e=>{ rt.remoteAudio.srcObject=e.streams[0]; };

        rt.dc=rt.pc.createDataChannel('oai-events');
        rt.dc.onopen=()=>{ 
          rt.dc.send(JSON.stringify({
            type:'session.update',
            session:{
              voice:'verse',
              turn_detection:{type:'server_vad'},
              tool_choice:{type:'auto'},
              instructions:`
Du √§r Coach Assistant f√∂r Linje 65.
Vid fr√•gor om drift/fels√∂kning/manual ska du ALLTID anv√§nda verktyget "search_manual" innan du svarar.
V√ÑNTA tills du har ett slutligt (final) transkript innan du kallar "search_manual".
N√§r du kallar "search_manual": skicka alltid { query: EXAKT senaste anv√§ndarens transkript }, inte tom str√§ng och inte parafras.
N√§r "search_manual" returnerar "strict_answer": L√ÑS UPP DET ORDAGRANT (max 2 meningar), utan egna till√§gg.
Om "strict_answer" saknas: S√§g att du inte kan verifiera i manualen och be om precisering (delomr√•de, felkod, maskin).
H√§lsning/sm√•prat kan besvaras utan verktyg.
`.trim(),
              tools:[
                { type:'function', name:'search_manual',
                  description:`S√∂k i Linje65-manualdatabasen och returnera kort verifierat svar n√§r m√∂jligt.`,
                  parameters:{ type:'object', properties:{
                    query:{type:'string',description:'Senaste transkriptet fr√•n anv√§ndaren'},
                    k:{type:'integer',default:5}, minSim:{type:'number',default:0.55}
                  }, required:['query'] }
                },
                { type:'function', name:'save_memory',
                  description:'Spara stabil fakta/inst√§llning i l√•ngtidsminne.',
                  parameters:{ type:'object', properties:{key:{type:'string'}, value:{type:'string'}}, required:['key','value']}
                }
              ]
            }
          }));
          append(pill('Realtime ansluten. Prata n√§r som helst.'));
        };
        rt.dc.onmessage=(e)=>{ try{ handleRealtimeMessage(JSON.parse(e.data)); }catch{} };

        const {token, model}=await fetchJSON('/api/rt-token');
        append(pill('Realtime modell: '+model));
        const offer=await rt.pc.createOffer(); await rt.pc.setLocalDescription(offer);
        const sdp=await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}`,{method:'POST',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/sdp','OpenAI-Beta':'realtime=v1'},body:offer.sdp}).then(r=>r.text());
        await rt.pc.setRemoteDescription({type:'answer',sdp});
        rt.connected=true; $('#rtBtn').style.display='none'; $('#rtHangup').style.display='inline-block'; status('Realtime ansluten');
      }catch(e){ console.error(e); $('#rtStatus').textContent=`Realtime fel`; append(errorBubble('Fel vid anslutning: '+(e?.message||e))); }
    }

    async function hangupRealtime(){
      try{ rt.dc?.close(); rt.pc?.getSenders()?.forEach(s=>s.track?.stop()); rt.pc?.close(); rt.mic?.getTracks()?.forEach(t=>t.stop()); micAnalyser=null; }catch{}
      rt={ pc:null, dc:null, mic:null, remoteAudio:null, connected:false,
           conversation_id:rt.conversation_id, _msgCount:rt._msgCount,
           _ragBusy:false, _lastQuery:"", _lastToolCallId:null,
           cancelAutos:false, skipCancelForNextCreate:false, allowedResponseIds:new Set(),
           _lastUserText:"", _liveUserBuf:"", _pendingTool:null };
      $('#rtBtn').style.display='inline-block'; $('#rtHangup').style.display='none'; $('#rtStatus').textContent='Inte ansluten'; append(pill('Samtal avslutat.'));
    }

    // ===== Realtime events ====
    function isTranscriptFinalType(t){
      return t && (
        /^(input_audio_buffer|input_text)\.(transcript|transcription|transcribe)\.(done|completed)$/.test(t) ||
        /^input_audio_buffer\.commit(ed)?$/.test(t)
      );
    }

    function resolveQueryFromState(args){
      let q=(args?.query||'').trim();
      if(!q && (rt._liveUserBuf||'').trim()) q=rt._liveUserBuf.trim();
      if(!q && (rt._lastUserText||'').trim()) q=rt._lastUserText.trim();
      if(!q && (rt._lastQuery||'').trim())    q=rt._lastQuery.trim();
      return q;
    }

    async function handleRealtimeMessage(msg){
      // Live transcript buffer
      try{
        const t=msg?.type||"";
        if (/(input_audio_buffer|input_text)\.transcript\.(started|start)$/.test(t)) rt._liveUserBuf="";
        if (/(input_audio_buffer|input_text)\.(transcript|transcription|transcribe)\.delta$/.test(t)) {
          const chunk=msg.delta||msg.text||"";
          if (chunk) rt._liveUserBuf=(rt._liveUserBuf||"")+chunk;
          // Om ett tool v√§ntar, f√∂rs√∂k trigga det s√• fort vi har text
          if (rt._pendingTool) tryRunPending('delta');
          scheduleSilenceFinalizer();
        }
      }catch{}

      // function-call args deltas
      if (msg.type==='response.function_call_arguments.delta'){
        const id=msg.id||msg.tool_call_id||msg.response_id||'unknown';
        const prev=toolCalls.get(id)||{name:msg.name,argsText:''};
        prev.argsText+=(msg.delta||msg.arguments_delta||'');
        prev.name=prev.name||msg.name;
        if (msg.response_id) prev.response_id=msg.response_id;
        toolCalls.set(id,prev);
        // om den h√§r toolen v√§ntar, uppdatera args och f√∂rs√∂k k√∂ra
        if (rt._pendingTool && rt._pendingTool.id===id){ rt._pendingTool.argsText=prev.argsText; tryRunPending('args-delta'); }
        return;
      }

      // tool-call (start)
      if (msg.type==='response.function_call'){
        const id=msg.id||msg.tool_call_id||msg.response_id||'unknown';
        const tc={ id, name:msg.name, argsText:msg.arguments||msg.args||'', response_id:msg.response_id||null, launched:false };
        toolCalls.set(id,tc);

        if (tc.name==='search_manual'){
          if (tc.launched) return;
          const args=(()=>{ try{ return JSON.parse(tc.argsText||'{}'); }catch{ return {}; }})();
          const q = resolveQueryFromState(args);
          if (q){
            tc.launched=true; toolCalls.set(id,tc);
            rt.cancelAutos=true; if (tc.response_id) rt.allowedResponseIds.add(tc.response_id);
            rt._ragBusy=true; rt._lastToolCallId=id; clearTimeout(ragTimer);
            ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
            const patchedArgs=JSON.stringify({ ...args, query:q });
            append(pill('üîé K√∂r manual-s√∂k'));
            return runToolSearchManual({ tool_call_id:id, response_id:tc.response_id, argsText:patchedArgs }).finally(()=>{});
          } else {
            // parkera tills vi f√•r text
            const deadline=Date.now()+WAIT_FOR_QUERY_MS;
            const interval=setInterval(()=>tryRunPending('timer'),120);
            rt._pendingTool={ id, argsText:tc.argsText||'{}', response_id:tc.response_id||null, deadline, interval };
            append(pill('‚è≥ V√§ntar p√• transkript‚Ä¶'));
          }
          return;
        }

        if (tc.name==='save_memory'){
          if (tc.launched) return;
          tc.launched=true; toolCalls.set(id,tc);
          return runToolSaveMemory(tc);
        }
        return;
      }

      // transcript final ‚Üí spara + (om inget pending) k√∂r fallback RAG
      if (isTranscriptFinalType(msg.type)){
        const text=(msg.transcript||msg.text||'').trim();
        if (text){
          append(bubble(text,'user')); logMsg('user',text,'voice',msg);
          rt._lastUserText=text; rt._liveUserBuf="";
          if (rt._pendingTool){ tryRunPending('final'); return; } // pending f√•r k√∂ra f√∂rst
          if (text.split(/\s+/).length<2) return;
          if (!rt._ragBusy && text!==rt._lastQuery){
            rt._ragBusy=true; rt._lastQuery=text; rt.cancelAutos=true; clearTimeout(ragTimer);
            ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
            runToolSearchManual({tool_call_id:null,response_id:null,argsText:JSON.stringify({query:text,k:5,minSim:0.55})}).finally(()=>{});
          }
        }
        return;
      }

      // Final text fr√•n modellen
      if (msg.type==='response.output_text.done'){
        const text=msg.output_text||msg.text||'';
        if(!text) return;
        if (rt.cancelAutos && !rt.allowedResponseIds.has(msg.response_id)){ append(pill('‚õî Avbr√∂t autosvar (v√§ntar p√• RAG)')); return; }
        append(bubble(text,'assistant')); logMsg('assistant',text,'model',{response_id:msg.response_id});
        return;
      }

      // Response created ‚Üí avbryt om vi ska ers√§tta med RAG
      if (msg.type==='response.created'){
        if (rt.skipCancelForNextCreate){ rt.skipCancelForNextCreate=false; return; }
        if (rt.cancelAutos){ append(pill('‚èπÔ∏è Stoppar autosvar (RAG p√• v√§g)')); rt.dc?.send(JSON.stringify({type:'response.cancel',response_id:msg.response_id})); return; }
      }
    }

    function tryRunPending(trigger){
      const p = rt._pendingTool; if (!p) return;
      // f√∂rs√∂k l√∂sa query
      let args={}; try{ args=JSON.parse(p.argsText||'{}'); }catch{}
      const q = resolveQueryFromState(args);
      if (q){
        clearInterval(p.interval); rt._pendingTool=null;
        // nu k√∂r vi p√• riktigt och ers√§tter autosvar
        rt.cancelAutos = true; if (p.response_id) rt.allowedResponseIds.add(p.response_id);
        rt._ragBusy = true; rt._lastToolCallId = p.id; clearTimeout(ragTimer);
        ragTimer = setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
        const patchedArgs = JSON.stringify({...args, query:q});
        append(pill('üîÅ K√∂r parkerad s√∂kning'));
        runToolSearchManual({tool_call_id:p.id,response_id:p.response_id,argsText:patchedArgs}).finally(()=>{});
        return;
      }
      if (Date.now() > p.deadline){
        clearInterval(p.interval); rt._pendingTool=null;
        // timeout ‚Üí returnera s√§kert tool-output och l√•t autosvar vara
        rt.cancelAutos=false; if (p.response_id) rt.allowedResponseIds.add(p.response_id);
        rt.dc?.send(JSON.stringify({
          type:'response.function_call_output',
          tool_call_id:p.id,
          output: JSON.stringify({ ok:false, error:'missing_query_timeout', need_user:true })
        }));
        append(pill('‚åõ Timeout: inget transkript att s√∂ka p√•'));
      }
    }

    // ===== RAG helpers & tools =====
    function parseArgsSafe(s){ try{ return JSON.parse(s||'{}'); }catch{ return {}; } }
    function isNumericQuestion(q){ const s=(q||'').toLowerCase(); return /\b(hur m√•nga|antal(?:et)?|how many|number of|count)\b/.test(s); }
    function hasAll(words,text){ const low=text.toLowerCase(); return words.every(w=>low.includes(w.toLowerCase())); }
    function extractNumericAnswer(snippets, keywordsAny=[], keywordsMust=[]){
      let best=null;
      for(const sn of (snippets||[])){
        const text=(sn.text||'').replace(/\s+/g,' ').trim();
        const sentences=text.split(/(?<=[\.\!\?:;])\s+/);
        for(const sent of sentences){
          const m=sent.match(/\b\d{1,4}(?:[.,]\d+)?\b/); if(!m) continue;
          if (keywordsMust.length && !hasAll(keywordsMust,sent)) continue;
          let sc=(sn.score||0); const low=sent.toLowerCase();
          for(const kw of keywordsAny) if(low.includes(kw.toLowerCase())) sc+=0.03;
          if (sent.length<20) sc-=0.1;
          if(!best || sc>best.sc) best={sent:sent.trim(), num:m[0], sn, sc};
        }
      }
      return best;
    }
    const DOMAIN_BOOST=['tapp','givare','sensor','ocme','fels√∂k','format','karusell','ventil'];
    function pickBestSentence(snippets, query){
      const q=(query||'').toLowerCase(); const tokens=q.split(/[^a-z√•√§√∂0-9]+/i).filter(t=>t.length>2);
      let best={s:'',score:-1,src:null};
      for(const sn of (snippets||[])){
        const text=(sn.text||'').replace(/\s+/g,' ').trim();
        const sents=text.split(/(?<=[\.\!\?:;])\s+/).slice(0,8);
        let score=(sn.score||0);
        for(const tok of tokens){ if(text.toLowerCase().includes(tok)) score+=0.01; }
        for(const b of DOMAIN_BOOST){ if(text.toLowerCase().includes(b)) score+=0.02; }
        if(text.toLowerCase().includes('fels√∂k')) score+=0.02;
        const bestSent=(sents.sort((a,b)=>a.length-b.length)[0]||text).slice(0,240);
        if(score>best.score){ best={s:bestSent, score, src:sn}; }
      }
      return best;
    }

    async function runToolSearchManual(tc){
      try{
        const args=parseArgsSafe(tc.argsText);
        const q=resolveQueryFromState(args);
        const body=JSON.stringify({ query:q, k: args.k||5, topK: args.topK||5, minSim: args.minSim ?? 0.55 });
        const data=await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body});
        append(pill(`RAG: count=${data.count||0}${data.fallback?' ‚Ä¢ fallback':''} ‚Ä¢ top1=${(data.snippets?.[0]?.score??0).toFixed(2)}`));
        if(!data.count){
          const out={ ok:true, strict_answer:null, best_sentence:null, numeric:null, fallback:data.fallback, top_score:null, sources:[] };
          if (tc.tool_call_id){
            rt.dc?.send(JSON.stringify({ type:'response.function_call_output', tool_call_id:tc.tool_call_id, output:JSON.stringify(out) }));
          } else { speakVerbatim('Inga tr√§ffar i manualen.'); }
          return;
        }

        let strict=null, bestSent=null;
        const isNum=isNumericQuestion(q);
        if(isNum){
          const hit=extractNumericAnswer(data.snippets,['givare','sensor'],['tapp']);
          if(hit?.sent){
            strict=`Enligt manualen: ${hit.sent}`;
            bestSent=hit.sent;
          }
        }
        if(!strict){
          const pick=pickBestSentence(data.snippets,q);
          if(pick?.s){
            bestSent=(pick.s || (data.snippets[0].text||'').replace(/\s+/g,' ').trim()).slice(0,500);
            strict=`Enligt manualen: ${bestSent}`;
          }
        }

        const sources=(data.snippets||[]).slice(0,5).map(s=>({title:s.title||'manual',idx:s.idx,score:s.score}));
        const out={ ok:true, strict_answer:strict||undefined, best_sentence:bestSent||undefined, numeric:isNum||undefined, fallback:data.fallback, top_score:(data.snippets?.[0]?.score??null), sources };

        if (tc.tool_call_id){
          rt.dc?.send(JSON.stringify({ type:'response.function_call_output', tool_call_id:tc.tool_call_id, output:JSON.stringify(out) }));
          append(pill('üì§ Skickade tool-output till modellen'));
        } else {
          if (out.strict_answer){
            speakVerbatim(out.strict_answer);
            const s0=sources[0]||{}; append(bubble(`${out.strict_answer}\nH√§mtat fr√•n: ${(s0.title||'manual')} ‚Ä¢ idx:${s0.idx??'?'} ‚Ä¢ score:${(s0.score??0).toFixed(2)}`,'assistant'));
          } else {
            speakVerbatim('Jag kan inte verifiera det i manualen just nu. Specificera del/omr√•de eller felkod s√• letar jag exakt.');
          }
        }
      }catch(err){
        console.error('search-manual error',err); append(errorBubble('Manual-s√∂k fel: '+(err?.message||err)));
        if(!tc.tool_call_id){ speakVerbatim('Kunde inte n√• manual-s√∂k just nu. F√∂rs√∂k igen strax.'); }
        else { rt.dc?.send(JSON.stringify({ type:'response.function_call_output', tool_call_id:tc.tool_call_id, output:JSON.stringify({ ok:false, error:'search-manual failed' }) })); }
      }finally{
        rt._ragBusy=false; clearTimeout(ragTimer);
      }
    }

    async function runToolSaveMemory(tc){
      const args=parseArgsSafe(tc.argsText);
      try{
        await fetch('/api/memory-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ key: String(args.key||'misc'), value: String(args.value||'') })});
        if (tc.tool_call_id){
          rt.dc?.send(JSON.stringify({ type:'response.function_call_output', tool_call_id:tc.tool_call_id, output: JSON.stringify({ ok:true }) }));
        } else { append(pill('üíæ Minnet sparat')); }
      }catch(e){
        if (tc.tool_call_id){
          rt.dc?.send(JSON.stringify({ type:'response.function_call_output', tool_call_id:tc.tool_call_id, output: JSON.stringify({ ok:false, error: e?.message||String(e) }) }));
        } else { append(pill('‚ùå Minnet kunde inte sparas')); }
      }
    }

    // ===== UI actions =====
    $('#sendTextBtn').addEventListener('click', sendTextToRealtime);
    $('#quickText').addEventListener('keydown', e => { if(e.key==='Enter') sendTextToRealtime(); });
    async function sendTextToRealtime(){
      const v=$('#quickText').value.trim(); if(!v) return;
      append(bubble(v,'user')); logMsg('user',v,'text');
      $('#quickText').value='';
      if(!rt?.dc?.readyState || rt.dc.readyState!=='open'){ append(errorBubble('Inte ansluten till Realtime √§nnu.')); return; }
      rt._lastUserText=v; rt._liveUserBuf='';
      // skapa en modell-sv√§ng; modellen kan v√§lja att kalla tool direkt
      rt.dc.send(JSON.stringify({ type:'response.create', response:{ input_text:v } }));
      // k√∂r fallback-RAG direkt f√∂r textv√§gen
      if (!rt._ragBusy && v!==rt._lastQuery){
        rt._ragBusy=true; rt._lastQuery=v; rt.cancelAutos=true; clearTimeout(ragTimer);
        ragTimer=setTimeout(()=>{ rt._ragBusy=false; rt.cancelAutos=false; }, RAG_TIMEOUT_MS);
        runToolSearchManual({tool_call_id:null,response_id:null,argsText:JSON.stringify({query:v,k:5,minSim:0.55})}).finally(()=>{});
      }
    }

    $('#manualBtn').addEventListener('click', testManualSearch);
    $('#manualQuery').addEventListener('keydown', e => { if(e.key==='Enter') testManualSearch(); });
    async function testManualSearch(){
      const q=$('#manualQuery').value.trim(); if(!q){ append(pill('Skriv en fr√•ga f√∂r manualen.')); return; }
      append(bubble('üîé Manual: '+q,'user'));
      try{
        const data=await fetchJSON('/api/search-manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,k:5,topK:5,minSim:0.55})});
        append(pill(`RAG: count=${data.count||0}${data.fallback?' ‚Ä¢ fallback':''} ‚Ä¢ top1=${(data.snippets?.[0]?.score??0).toFixed(2)}`));
        if(!data.count){ append(bubble('Inga tr√§ffar i manualen.','assistant')); return; }
        const isNum=/\b(hur m√•nga|antal(?:et)?|how many|number of|count)\b/i.test(q);
        if(isNum){
          const hit=extractNumericAnswer(data.snippets,['givare','sensor'],['tapp']);
          if(hit?.sent){ append(bubble(`Enligt manualen: ${hit.sent}\nH√§mtat fr√•n: ${(hit.sn?.title||'manual')} ‚Ä¢ idx:${hit.sn?.idx??'?'} ‚Ä¢ score:${(hit.sn?.score??0).toFixed(2)}`,'assistant')); }
          else { append(bubble('Kan inte verifiera exakt antal i manualen. Specificera del/omr√•de eller felkod s√• s√∂ker jag igen.','assistant')); }
        } else{
          const pick=pickBestSentence(data.snippets,q);
          const top=pick.src||data.snippets[0];
          const chosen=(pick.s||(top.text||'').replace(/\s+/g,' ').trim()).slice(0,500);
          append(bubble(`${chosen}\nH√§mtat fr√•n: ${(top.title||'manual')} ‚Ä¢ idx:${top.idx??'?'} ‚Ä¢ score:${(top.score??0).toFixed(2)}`,'assistant'));
        }
      }catch(e){ append(errorBubble('Manual-s√∂k fel: '+e.message)); }
    }
  </script>
</body>
</html>
